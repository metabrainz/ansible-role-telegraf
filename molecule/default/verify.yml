---
- name: Verify
  hosts: all
  gather_facts: false
  tasks:
    - name: Ensure Telegraf is installed
      ansible.builtin.stat:
        path: "/usr/bin/telegraf"
      register: result
      changed_when: false
      failed_when: result.stat.isreg is not defined or not result.stat.isreg

    - name: Ensure Telegraf is running
      ansible.builtin.service:
        name: telegraf
        state: started
      check_mode: true
      register: result
      failed_when: result is changed

    - name: Ensure Telegraf configuration files are correct
      ansible.builtin.copy:
        src: "{{ item | basename }}"
        dest: "/etc/telegraf/{{ item }}"
        mode: "0644"
      check_mode: true
      diff: true
      register: result
      failed_when: result is changed
      loop:
        - telegraf.conf
        - telegraf.d/ansible-inputs.conf
        - telegraf.d/ansible-processors.conf

    - name: Ensure Telegraf default file is correct
      ansible.builtin.copy:
        content: |
          # Ansible managed: Do NOT edit this file manually!

          TELEGRAF_OPTS='--input-filter cpu:disk:kernel:mem:swap:system'
        dest: /etc/default/telegraf
        mode: "0644"
      check_mode: true
      diff: true
      register: result
      failed_when: result is changed

    - name: Ensure sudo configuration is correct
      ansible.builtin.copy:
        content: |
          # Ansible managed: Do NOT edit this file manually!

          Cmnd_Alias TELEGRAF_CMDS = /usr/bin/ls /, /usr/bin/cat /foo
          Defaults!TELEGRAF_CMDS !logfile, !syslog, !pam_session
          telegraf ALL=(ALL) NOPASSWD: TELEGRAF_CMDS
        dest: /etc/sudoers.d/ansible-telegraf
        mode: "0640"
        owner: root
        group: root
      check_mode: true
      diff: true
      register: result
      failed_when: result is changed
